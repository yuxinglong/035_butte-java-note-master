# 一、内存与线程

## 1、内存结构

内存是计算机的重要部件之一,它是外存与CPU进行沟通的桥梁，计算机中所有程序的运行都在内存中进行，内存性能的强弱影响计算机整体发挥的水平。JVM的内存结构规定Java程序在执行时内存的申请、划分、使用、回收的管理策略，通说来说JVM的内存管理指运行时数据区这一大块的管理。

![](https://images.gitee.com/uploads/images/2021/0823/223617_1c919537_5064118.png "03-1.png")

## 2、线程运行

JVM中一个应用是可以有多个线程并行执行，线程被一对一映射为服务所在操作系统线程，调度在可用的CPU上执行，启动时会创建一个操作系统线程；当该线程终止时，这个操作系统线程也会被回收。

![](https://images.gitee.com/uploads/images/2021/0823/223631_aad8c4ed_5064118.jpeg "03-2.jpg")

在虚拟机启动运行时，会创建多个线程，数据区中有的模块是线程共享的，有的是线程私有的：

![](https://images.gitee.com/uploads/images/2021/0823/223644_95570f49_5064118.png "03-3.png")

线程共享：元数据区、堆Heap；

线程私有：虚拟机栈、本地方法栈、程序计数器； 

单个CPU在特定时刻只能执行一个线程，所以多线程通过几块空间的使用，然后不断的争抢CPU的执行时间段。

# 二、元数据空间

**基本描述**

方法元空间(方法区)在JVM启动的时候被创建，是被各个线程共享的内存空间，用于存放类和方法的元数据以及常量池，比如Class和Method。

在实际的开发中，经常因为加载的类太多，进而导致内存溢出问题，这样可以对元空间的大小进行扩展。

**与堆的关系**

![](https://images.gitee.com/uploads/images/2021/0823/223701_3c4ec48a_5064118.png "03-4.png")

元空间存放加载的类信息，当类被实例化时，堆中存储实例化的对象信息，并且通过对象类型数据的指针找到类。

# 三、堆空间

**基本描述**

JVM启动时创建堆区，是内存管理的核心区，通常情况下也是最大的内存空间，是被所有线程共享的，几乎所有的对象实例都要在堆中分配内存，所以这里也是垃圾回收的重点空间。

**堆栈关系**

![](https://images.gitee.com/uploads/images/2021/0823/223722_fed0cd9c_5064118.png "03-5.png")

栈是JVM运行时的单位，堆是存储单位，当栈中方法结束，相关对象失去所有引用后，不会马上被移除堆空间，要等到垃圾收集器运行的时候。

# 四、虚拟机栈

虚拟机栈(Java栈)在每个线程创建时都会生成一个虚拟机栈，栈的内部是一个个栈帧单元，对应Java方法的调用，其生命周期和线程周期保持一致。用来存储方法的局部遍历，部分执行结果，方法的调用和返回。

![](https://images.gitee.com/uploads/images/2021/0823/223749_5d0b498b_5064118.png "03-6.png")

栈帧是方法执行的数据集，维持执行过程中的各种数据信息，执行的方法依次入栈，栈顶存放当前要执行的方法，执行结束后出栈，对于栈没有垃圾回收问题。

# 五、程序计数器

**基本描述**

JVM中程序计数寄存器用来存储下一条将要执行指令的地址，执行引擎获取到指令后进行执行，是线程私有的。它可以看作是当前线程所执行的字节码的行号指示器。

![](https://images.gitee.com/uploads/images/2021/0823/223800_3c0bde03_5064118.png "03-7.png")

**前后关系**

线程在获取CPU的时间段内执行代码，但是线程随时可能没有执行完就被挂起，等到线程A再次获取CPU执行时，CPU 得知道执行到线程A的哪一个指令，程序计数器会存储该动作。

# 六、本地方法栈

本地方法栈与虚拟机栈所起到的作用是类似的，虚拟机栈为虚拟机执行Java方法，本地方法栈管理虚拟机使用到的 本地方法，在虚拟机规范中对本地方法栈中方法使用的语言、使用方式与数据结构并没有强制规定，因此具体的虚拟机可以自由实现它。HotSpot虚拟机直接就把本地方法栈和虚拟机栈合二为一。

**源码参考：** https://gitee.com/cicadasmile/java-base-parent